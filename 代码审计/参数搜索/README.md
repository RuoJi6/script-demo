# å‚æ•°è¿‡æ»¤æ£€æµ‹å·¥å…· (parameter_filter_checker.py)

## ğŸ” å·¥å…·æ¦‚è¿°

`parameter_filter_checker.py` æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºæ£€æµ‹PHPä»£ç ä¸­ç‰¹å®šå‚æ•°æ ¼å¼æ˜¯å¦ç¼ºå°‘å®‰å…¨è¿‡æ»¤çš„å®¡è®¡å·¥å…·ã€‚å®ƒä¸“æ³¨äºæ£€æµ‹ `$_x_xxxx` ç±»å‹çš„å‚æ•°æ˜¯å¦ä½¿ç”¨äº† `pe_dbhold()` å’Œ `intval()` è¿‡æ»¤å‡½æ•°ã€‚

## ğŸ¯ ä¸»è¦åŠŸèƒ½

### 1. å‚æ•°æ¨¡å¼åŒ¹é…
ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ç²¾ç¡®åŒ¹é…ç‰¹å®šæ ¼å¼çš„å‚æ•°ï¼š

#### åŒ¹é…æ¨¡å¼
```regex
\$_[a-zA-Z]_[a-zA-Z0-9_]*
```

#### åŒ¹é…ç¤ºä¾‹
```php
$_a_test          // âœ… åŒ¹é…
$_b_user_id       // âœ… åŒ¹é…  
$_c_file_name     // âœ… åŒ¹é…
$_d_data_info_123 // âœ… åŒ¹é…
$_ab_test         // âŒ ä¸åŒ¹é…ï¼ˆç¬¬äºŒéƒ¨åˆ†è¶…è¿‡1ä¸ªå­—ç¬¦ï¼‰
$_1_test          // âŒ ä¸åŒ¹é…ï¼ˆç¬¬ä¸€éƒ¨åˆ†ä¸æ˜¯å­—æ¯ï¼‰
```

### 2. è¿‡æ»¤å‡½æ•°æ£€æµ‹
æ£€æµ‹å‚æ•°æ˜¯å¦è¢«ä»¥ä¸‹å®‰å…¨å‡½æ•°åŒ…å›´ï¼š

#### æ”¯æŒçš„è¿‡æ»¤å‡½æ•°
- `pe_dbhold()` - æ•°æ®åº“è½¬ä¹‰å‡½æ•°
- `intval()` - æ•´æ•°è½¬æ¢å‡½æ•°

#### æ£€æµ‹æ¨¡å¼
```php
// ç›´æ¥åŒ…å›´
pe_dbhold($_a_test)
intval($_b_user_id)

// èµ‹å€¼ä½¿ç”¨
$var = pe_dbhold($_c_file_name)
$num = intval($_d_count)

// æ•°ç»„è®¿é—®
pe_dbhold($_e_data['key'])
intval($_f_info['id'])
```

### 3. é£é™©ç­‰çº§è¯„ä¼°
æ ¹æ®å‚æ•°çš„ä½¿ç”¨åœºæ™¯è¯„ä¼°å®‰å…¨é£é™©ï¼š

#### é«˜é£é™© ğŸš¨
å‚æ•°ç›´æ¥ç”¨äºå±é™©æ“ä½œï¼š
```php
// SQLæŸ¥è¯¢
$sql = "SELECT * FROM users WHERE id = " . $_a_user_id;

// æ–‡ä»¶æ“ä½œ  
include($_b_file_name);
unlink($_c_file_path);

// å‘½ä»¤æ‰§è¡Œ
exec($_d_command);
system($_e_cmd);
```

#### ä¸­é£é™© âš ï¸
å‚æ•°ç”¨äºè¾“å‡ºæˆ–å­—ç¬¦ä¸²æ“ä½œï¼š
```php
// è¾“å‡ºæ“ä½œ
echo $_a_message;
print $_b_content;

// å¤´éƒ¨è®¾ç½®
header("Location: " . $_c_url);
setcookie("name", $_d_value);

// å­—ç¬¦ä¸²æ‹¼æ¥
$result = "Hello " . $_e_name;
```

#### ä½é£é™© âš¡
å…¶ä»–ä¸€èˆ¬ç”¨é€”ï¼š
```php
// ç®€å•èµ‹å€¼
$data = $_a_info;

// æ¡ä»¶åˆ¤æ–­
if ($_b_flag) { ... }

// æ•°ç»„æ“ä½œ
$array[$_c_key] = $value;
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨
```bash
python parameter_filter_checker.py
```

### äº¤äº’å¼æ“ä½œ
1. è¾“å…¥è¦æ£€æµ‹çš„ç›®å½•è·¯å¾„
2. é€‰æ‹©è¾“å‡ºæ–‡ä»¶åï¼ˆå¯é€‰ï¼‰
3. ç­‰å¾…æ‰«æå®Œæˆ

### ç¤ºä¾‹
```bash
$ python parameter_filter_checker.py
å‚æ•°è¿‡æ»¤æ£€æµ‹å·¥å…·
========================================
æ£€æµ‹ç›®æ ‡ï¼š$_x_xxxx ç±»å‹å‚æ•°æ˜¯å¦ç¼ºå°‘è¿‡æ»¤å‡½æ•°
æ£€æµ‹çš„è¿‡æ»¤å‡½æ•°: pe_dbhold, intval

è¯·è¾“å…¥è¦æ£€æµ‹çš„ç›®å½•è·¯å¾„: /var/www/html/project
è¾“å‡ºæ–‡ä»¶å (é»˜è®¤: parameter_filter_report.txt): 
å¼€å§‹æ‰«æç›®å½•: /var/www/html/project
æ­£åœ¨æ£€æµ‹æœªè¿‡æ»¤çš„å‚æ•°...
å‘ç°æœªè¿‡æ»¤å‚æ•°: /var/www/html/project/admin/user.php (3 ä¸ª)
```

## ğŸ“Š è¾“å‡ºæŠ¥å‘Š

### æŠ¥å‘Šå†…å®¹
ç”Ÿæˆçš„ `parameter_filter_report.txt` åŒ…å«ï¼š

1. **ç»Ÿè®¡ä¿¡æ¯**
   - æ‰«æç›®å½•å’Œæ–‡ä»¶æ•°é‡
   - æœªè¿‡æ»¤å‚æ•°æ€»æ•°
   - å„é£é™©ç­‰çº§ç»Ÿè®¡

2. **è¯¦ç»†å‚æ•°ä¿¡æ¯**
   - å‚æ•°åç§°å’Œæ‰€åœ¨è¡Œå·
   - é£é™©ç­‰çº§è¯„ä¼°
   - å®Œæ•´ä»£ç å†…å®¹
   - ä½¿ç”¨çš„è¿‡æ»¤å‡½æ•°ï¼ˆå¦‚æœæœ‰ï¼‰

### æŠ¥å‘Šç¤ºä¾‹
```
å‚æ•°è¿‡æ»¤æ£€æµ‹æŠ¥å‘Š
============================================================
æ‰«æç›®å½•: /var/www/html/project
æ€»è®¡PHPæ–‡ä»¶æ•°: 156
å­˜åœ¨æœªè¿‡æ»¤å‚æ•°çš„æ–‡ä»¶æ•°: 8
æœªè¿‡æ»¤å‚æ•°æ€»æ•°: 23
é«˜é£é™©å‚æ•°æ•°: 5
ä¸­é£é™©å‚æ•°æ•°: 12
æ£€æµ‹çš„è¿‡æ»¤å‡½æ•°: pe_dbhold, intval
============================================================

æ£€æµ‹åˆ°çš„æœªè¿‡æ»¤å‚æ•°:
----------------------------------------

æ–‡ä»¶: /var/www/html/project/admin/user.php
æ€»å‚æ•°æ•°: 5
æœªè¿‡æ»¤å‚æ•°æ•°: 3
å·²è¿‡æ»¤å‚æ•°æ•°: 2

æœªè¿‡æ»¤çš„å‚æ•°:
  å‚æ•°: $_a_user_id
  è¡Œå·: 15
  é£é™©ç­‰çº§: é«˜é£é™©
  ä»£ç : $sql = "SELECT * FROM users WHERE id = " . $_a_user_id;
  ------------------------------
  å‚æ•°: $_b_message
  è¡Œå·: 20
  é£é™©ç­‰çº§: ä¸­é£é™©
  ä»£ç : echo $_b_message;
  ------------------------------

å·²è¿‡æ»¤çš„å‚æ•°:
  å‚æ•°: $_c_safe_id
  è¡Œå·: 25
  ä½¿ç”¨çš„è¿‡æ»¤å‡½æ•°: intval
  ä»£ç : $id = intval($_c_safe_id);
  ------------------------------
```

## ğŸ”§ æ£€æµ‹åŸç†

### 1. æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
```python
# å‚æ•°åŒ¹é…æ¨¡å¼
param_pattern = r'\$_[a-zA-Z]_[a-zA-Z0-9_]*'

# æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„å‚æ•°
matches = re.finditer(param_pattern, content)
```

### 2. ä¸Šä¸‹æ–‡åˆ†æ
æ£€æŸ¥å‚æ•°æ‰€åœ¨è¡ŒåŠå‰åå‡ è¡Œçš„ä»£ç ï¼š
```python
# æ£€æŸ¥å½“å‰è¡Œå’Œå‰åå‡ è¡Œ
check_lines = []
for i in range(max(0, line_number - 3), min(len(lines), line_number + 2)):
    check_lines.append(lines[i])
```

### 3. è¿‡æ»¤å‡½æ•°è¯†åˆ«
```python
# è¿‡æ»¤å‡½æ•°æ£€æµ‹æ¨¡å¼
filter_patterns = [
    rf'{filter_func}\s*\(\s*\{re.escape(param)}\s*\)',
    rf'\$\w+\s*=\s*{filter_func}\s*\(\s*\{re.escape(param)}\s*\)',
    rf'{filter_func}\s*\(\s*\{re.escape(param)}\[.*?\]\s*\)',
]
```

### 4. é£é™©è¯„ä¼°
æ ¹æ®ä»£ç å†…å®¹ä¸­çš„å…³é”®è¯åˆ¤æ–­é£é™©ç­‰çº§ï¼š
```python
# é«˜é£é™©å…³é”®è¯
high_risk_patterns = [
    'select', 'insert', 'update', 'delete', 'mysql_query',
    'file_get_contents', 'fopen', 'include', 'require', 
    'exec', 'system', 'shell_exec'
]
```

## âš™ï¸ é…ç½®é€‰é¡¹

### è‡ªå®šä¹‰è¿‡æ»¤å‡½æ•°
ä¿®æ”¹ `FILTER_FUNCTIONS` åˆ—è¡¨ï¼š
```python
FILTER_FUNCTIONS = [
    'pe_dbhold',
    'intval', 
    'mysql_real_escape_string',  # æ·»åŠ å…¶ä»–è¿‡æ»¤å‡½æ•°
    'htmlspecialchars',
    'strip_tags'
]
```

### è‡ªå®šä¹‰å‚æ•°æ¨¡å¼
å¦‚æœéœ€è¦æ£€æµ‹å…¶ä»–æ ¼å¼çš„å‚æ•°ï¼Œä¿®æ”¹æ­£åˆ™è¡¨è¾¾å¼ï¼š
```python
# ä¾‹å¦‚æ£€æµ‹ $_param_xxx æ ¼å¼
param_pattern = r'\$_param_[a-zA-Z0-9_]*'

# æˆ–è€…æ£€æµ‹ $global_xxx æ ¼å¼  
param_pattern = r'\$global_[a-zA-Z0-9_]*'
```

### è°ƒæ•´é£é™©è¯„ä¼°
åœ¨ `analyze_risk_level` å‡½æ•°ä¸­è‡ªå®šä¹‰é£é™©å…³é”®è¯ï¼š
```python
# æ·»åŠ é¡¹ç›®ç‰¹å®šçš„é«˜é£é™©å…³é”®è¯
high_risk_patterns.extend([
    'your_dangerous_function',
    'project_specific_risk'
])
```

## ğŸ›¡ï¸ ä¿®å¤å»ºè®®

### 1. æ·»åŠ è¿‡æ»¤å‡½æ•°
```php
// æ•°æ®åº“æ“ä½œå‰è¿‡æ»¤
$safe_id = pe_dbhold($_a_user_id);
$sql = "SELECT * FROM users WHERE id = " . $safe_id;

// æ•´æ•°ç±»å‹è½¬æ¢
$safe_num = intval($_b_count);
$limit = "LIMIT " . $safe_num;
```

### 2. è¾“å…¥éªŒè¯
```php
// ç™½åå•éªŒè¯
$allowed_actions = ['view', 'edit', 'delete'];
if (!in_array($_c_action, $allowed_actions)) {
    die('Invalid action');
}

// æ ¼å¼éªŒè¯
if (!preg_match('/^[a-zA-Z0-9_]+$/', $_d_filename)) {
    die('Invalid filename format');
}
```

### 3. ç±»å‹å¼ºåˆ¶è½¬æ¢
```php
// å¼ºåˆ¶è½¬æ¢ä¸ºå®‰å…¨ç±»å‹
$page = (int)$_e_page;
$limit = (float)$_f_price;
$flag = (bool)$_g_status;
```

## ğŸ”„ æœ€ä½³å®è·µ

### 1. å¼€å‘è§„èŒƒ
- æ‰€æœ‰ç”¨æˆ·è¾“å…¥å¿…é¡»ç»è¿‡è¿‡æ»¤
- ä½¿ç”¨ç±»å‹è½¬æ¢å‡½æ•°å¤„ç†æ•°å€¼å‚æ•°
- å»ºç«‹å‚æ•°å‘½åè§„èŒƒ

### 2. ä»£ç å®¡æŸ¥
- å°†æ­¤å·¥å…·é›†æˆåˆ°ä»£ç å®¡æŸ¥æµç¨‹
- å®šæœŸæ‰«ææ–°å¢ä»£ç 
- é‡ç‚¹å…³æ³¨é«˜é£é™©å‚æ•°

### 3. å®‰å…¨åŸ¹è®­
- åŸ¹è®­å¼€å‘äººå‘˜æ­£ç¡®ä½¿ç”¨è¿‡æ»¤å‡½æ•°
- å»ºç«‹å®‰å…¨ç¼–ç æŒ‡å—
- å®šæœŸè¿›è¡Œå®‰å…¨æ„è¯†åŸ¹è®­

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç²¾ç¡®åŒ¹é…**ï¼šåªæ£€æµ‹ç‰¹å®šæ ¼å¼çš„å‚æ•°ï¼Œå¯èƒ½é—æ¼å…¶ä»–æ ¼å¼
2. **ä¸Šä¸‹æ–‡é™åˆ¶**ï¼šåªæ£€æŸ¥å‚æ•°é™„è¿‘çš„ä»£ç ï¼Œå¯èƒ½é—æ¼è¿œç¨‹è¿‡æ»¤
3. **è¯¯æŠ¥å¯èƒ½**ï¼šæŸäº›å®‰å…¨çš„ç”¨æ³•å¯èƒ½è¢«è¯¯åˆ¤ä¸ºå±é™©
4. **äººå·¥éªŒè¯**ï¼šå»ºè®®å¯¹æ£€æµ‹ç»“æœè¿›è¡Œäººå·¥ç¡®è®¤

## ğŸ”§ ç¯å¢ƒè¦æ±‚

- Python 3.6+
- æ ‡å‡†åº“ï¼š`os`, `re`, `sys`, `pathlib`
- æ— éœ€é¢å¤–ä¾èµ–

è¿™ä¸ªå·¥å…·ä¸“æ³¨äºç‰¹å®šå‚æ•°æ ¼å¼çš„å®‰å…¨æ£€æµ‹ï¼Œæ˜¯PHPä»£ç å®‰å…¨å®¡è®¡å·¥å…·é“¾ä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼
